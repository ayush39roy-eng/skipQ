generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  email        String    @unique
  name         String
  passwordHash String
  role         String    @default("USER")
  vendor       Vendor?   @relation(fields: [vendorId], references: [id])
  vendorId     String?
  sessions     Session[]
  orders       Order[]
  createdAt    DateTime  @default(now())
}

model Vendor {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String?
  whatsappEnabled Boolean @default(false)
  users     User[]
  canteens  Canteen[]
  orders    Order[]
  createdAt DateTime  @default(now())
}

model Canteen {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  location  String
  vendor    Vendor     @relation(fields: [vendorId], references: [id])
  vendorId  String
  // Optional additional notification phone numbers (E.164) for WhatsApp alerts.
  notificationPhones String[] @default([])
  
  // Timings and Status
  openingTime   String?   // Format: "HH:mm" (24-hour) - DEPRECATED, use weeklySchedule
  closingTime   String?   // Format: "HH:mm" (24-hour) - DEPRECATED, use weeklySchedule
  
  // Weekly schedule: JSON array of 7 objects (Mon-Sun)
  // Each object: { day: "Monday", isOpen: true, openingTime: "09:00", closingTime: "17:00" }
  weeklySchedule Json?     @default("[{\"day\":\"Monday\",\"isOpen\":true,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"},{\"day\":\"Tuesday\",\"isOpen\":true,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"},{\"day\":\"Wednesday\",\"isOpen\":true,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"},{\"day\":\"Thursday\",\"isOpen\":true,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"},{\"day\":\"Friday\",\"isOpen\":true,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"},{\"day\":\"Saturday\",\"isOpen\":true,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"},{\"day\":\"Sunday\",\"isOpen\":false,\"openingTime\":\"09:00\",\"closingTime\":\"21:00\"}]")
  
  autoMode      Boolean   @default(true)
  manualIsOpen  Boolean   @default(true)

  menuItems MenuItem[]
  orders    Order[]
}

model MenuItem {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  canteen    Canteen     @relation(fields: [canteenId], references: [id])
  canteenId  String
  name       String
  priceCents Int
  available  Boolean     @default(true)
  imageUrl   String?
  description String?
  orderItems OrderItem[]
}

model Order {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  user             User          @relation(fields: [userId], references: [id])
  userId           String
  canteen          Canteen       @relation(fields: [canteenId], references: [id])
  canteenId        String
  vendor           Vendor?       @relation(fields: [vendorId], references: [id])
  vendorId         String?
  items            OrderItem[]
  status           String        @default("PENDING")
  fulfillmentType  String        @default("TAKEAWAY")
  totalCents       Int           @default(0)
  commissionCents  Int           @default(0)
  vendorTakeCents  Int           @default(0)
  prepMinutes      Int?
  payment          Payment?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model OrderItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id])
  menuItemId  String
  quantity    Int
  priceCents  Int
}

model Payment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  order           Order    @relation(fields: [orderId], references: [id])
  orderId         String   @unique
  amountCents     Int
  status          String   @default("PENDING")
  provider        String   @default("stub")
  paymentLink     String
  externalOrderId String?  // Cashfree order_id (or provider reference)
  paidAt          DateTime?
}

model Session {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  token     String   @unique
  role      String
  createdAt DateTime @default(now())
  expiresAt DateTime
}
